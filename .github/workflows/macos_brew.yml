  name: CI macOS (Homebrew + Clang)

  on:
    push:
      branches: ["main", "develop"]
    pull_request:
      branches: ["main", "develop"]
    workflow_dispatch:

  env:
   CMAKE_GENERATOR: Ninja

  jobs:
    build:
      runs-on: macos-latest
      timeout-minutes: 15

      strategy:
        matrix:
          build-type: [Release]
          include:
            - build-type: Release
              preset: release-homebrew
            - build-type: Debug
              preset: debug-homebrew

      steps:
        # ====================================================================
        # Checkout
        # ====================================================================
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            submodules: recursive
            fetch-depth: 0

        # ====================================================================
        # Install dependencies via Homebrew
        # ====================================================================
        - name: Install Homebrew dependencies
          run: |
            brew update
            brew install spdlog
            brew install openimageio
            brew install halide 
            brew install exiv2
            brew install magic_enum
            brew install llvm

            # Optional: Halide (if available in homebrew)
            # brew install halide
            
            brew list --versions spdlog openimageio halide llvm
      
          # ====================================================================
          # Configure cmake environment for LLVM (to ensure C++23 support)
          # ============================================================
        - name: Configure CMake for lastest LLVM
          id: configure
          run: |
           export CMAKE_PREFIX_PATH="$(brew --prefix qt):$CMAKE_PREFIX_PATH"

           # ============================================================
           # Set Clang as the default compiler to ensure C++23 support (since Apple Clang may not support it yet)
           # ============================================================
           export CC=/opt/homebrew/opt/llvm/bin/clang
           export CXX=/opt/homebrew/opt/llvm/bin/clang++
          shell: bash

      # ====================================================================
      # Setup Qt
      # ====================================================================
        - name: Setup Qt 6.10.2 Environment
          uses: jurplel/install-qt-action@v4 
          with:
           version: '6.10.2'
           target: 'desktop'
           host: 'mac'
           modules: 'qtshadertools'

        # ====================================================================
        # Verify Clang C++23 Support
        # ====================================================================
        - name: Verify Clang C++23 Support
          run: |
           "$(brew --prefix llvm)/bin/clang++" --version
           echo "Checking C++23 support..."
           "$(brew --prefix llvm)/bin/clang++" -std=c++23 -x c++ -E - <<< '#include <version>' && echo "C++23 supported" || echo "C++23 not supported"
          shell: bash

        # ====================================================================
        # Configure cmake environment
        # ====================================================================
        - name: Configure CMake
          run: |
           export LLVM_PREFIX=$(brew --prefix llvm)
           export SDKROOT=$(xcrun --show-sdk-path)
           
           TESTS_FLAG="-Dtests=OFF"
          
           if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
             TESTS_FLAG="-Dtests=ON"
             echo "::notice file=tests::the directory 'tests' exists and is not empty. Tests enabled."
           else
             echo "::warning file=tests::the directory 'tests' is empty or missing. Tests disabled (Tests:OFF)."
           fi

           cmake \
           --preset ${{ matrix.preset }} \
           -Ddesktop_ui=ON \
           ${TESTS_FLAG} \
           -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
           -DCMAKE_C_COMPILER=${LLVM_PREFIX}/bin/clang \
           -DCMAKE_CXX_COMPILER=${LLVM_PREFIX}/bin/clang++
          shell: bash

        # ====================================================================
        # Build
        # ====================================================================
        - name: Build Project
          run: |
           cmake --build build/${{ matrix.preset }} --config ${{ matrix.build-type }} --parallel $(sysctl -n hw.ncpu)
          shell: bash

        # ====================================================================
        # Test
        # ====================================================================
        - name: Run Tests
          run: |
           cd build/${{ matrix.preset }}
           ctest --output-on-failure -C ${{ matrix.build-type }}
          shell: bash

        # ====================================================================
        # Upload build artifacts
        # ====================================================================
        - name: Upload build artifacts
          if: always()
          uses: actions/upload-artifact@v4
          with:
           name: build-macos-${{ matrix.build-type }}
           path: |
             build/${{ matrix.preset }}/ui/desktop/*.dmg
             build/${{ matrix.preset }}/ui/desktop/*.app
           retention-days: 7
           if-no-files-found: warn